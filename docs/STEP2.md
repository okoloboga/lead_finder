# LeadSense Bot — Техническое задание v3

## Обзор

### Цель
Telegram-бот для автоматического сбора и доставки B2B лидов. Пользователь создаёт "программы" (ниша + список чатов), бот автоматически парсит их по расписанию и присылает квалифицированных лидов в личные сообщения.

### Ключевые возможности
- Создание нескольких программ поиска (селлеры, инфобизнес, логистика и т.д.)
- Автоматический парсинг по расписанию (раз в сутки)
- Доставка лидов в Telegram с удобным форматированием
- Управление всем через inline-кнопки (без команд)
- Дедупликация — не присылать одного лида дважды

---

## Концепция "Программы"

**Программа** — это сохранённая конфигурация поиска:

```
Программа "Селлеры WB"
├── Ниша: "селлеры wildberries и маркетплейсов"
├── Чаты для парсинга:
│   ├── @marketplace_pro
│   ├── @wb_sellers_chat
│   └── @ozon_community
├── Настройки:
│   ├── min_score: 6
│   ├── max_leads_per_run: 20
│   └── messages_limit: 100
└── Расписание: ежедневно в 09:00
```

Пользователь может иметь несколько программ, каждая работает независимо.

---

## Интерфейс бота

### Принцип
Всё управление через inline-кнопки. Никаких команд кроме /start для первого запуска. После /start пользователь видит главное меню и дальше навигирует только кнопками.

---

### Главное меню

При запуске бота или нажатии "🏠 Главное меню":

```
🎯 LeadSense

Нахожу потенциальных клиентов в Telegram-чатах
и присылаю тебе готовые карточки для аутрича.

┌─────────────────────────────────┐
│  [📋 Мои программы]             │
│  [➕ Создать программу]          │
│  [📊 Статистика]                │
│  [⚙️ Настройки]                 │
└─────────────────────────────────┘
```

---

### Мои программы

При нажатии "📋 Мои программы":

**Если программ нет:**
```
📋 Мои программы

У тебя пока нет программ поиска.
Создай первую — это займёт пару минут.

┌─────────────────────────────────┐
│  [➕ Создать программу]          │
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

**Если программы есть:**
```
📋 Мои программы

1️⃣ Селлеры маркетплейсов
   3 чата • скор ≥5 • ⏰ 09:00
   Последний запуск: сегодня, 12 лидов

2️⃣ Инфобизнес  
   2 чата • скор ≥6 • ⏰ 10:00
   Последний запуск: вчера, 8 лидов

┌─────────────────────────────────┐
│  [1️⃣ Селлеры]  [2️⃣ Инфобиз]    │
│  [➕ Создать ещё]                │
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

---

### Карточка программы

При выборе конкретной программы:

```
📁 Селлеры маркетплейсов

Ниша: селлеры wildberries, ozon, малый бизнес

Чаты:
• @marketplace_pro
• @wb_sellers_chat  
• @ozon_community

Настройки:
• Минимальный скор: 5
• Лидов за запуск: макс 20
• Расписание: ежедневно в 09:00 ✅

Статистика:
• Всего найдено: 47 лидов
• Последний запуск: сегодня в 09:00

┌─────────────────────────────────┐
│  [▶️ Запустить сейчас]          │
├─────────────────────────────────┤
│  [✏️ Изменить]  [🗑 Удалить]    │
├─────────────────────────────────┤
│  [◀️ К программам]              │
└─────────────────────────────────┘
```

---

### Создание программы (пошаговый диалог)

При нажатии "➕ Создать программу":

**Шаг 1 — Название:**
```
➕ Новая программа

Шаг 1 из 4: Название

Как назовём программу?
Например: "Селлеры WB", "Инфобизнес", "Логистика"

┌─────────────────────────────────┐
│  [❌ Отмена]                     │
└─────────────────────────────────┘
```
*Пользователь вводит текст*

**Шаг 2 — Описание ниши:**
```
➕ Новая программа: "Селлеры WB"

Шаг 2 из 4: Описание ниши

Опиши, кого ищем. Это поможет лучше 
квалифицировать лидов.

Например: "селлеры wildberries и ozon, 
малый бизнес, ищут автоматизацию"

┌─────────────────────────────────┐
│  [◀️ Назад]  [❌ Отмена]        │
└─────────────────────────────────┘
```
*Пользователь вводит текст*

**Шаг 3 — Чаты:**
```
➕ Новая программа: "Селлеры WB"

Шаг 3 из 4: Чаты для парсинга

Отправь список чатов, из которых собирать лидов.
Можно несколько в одном сообщении, каждый с новой строки.

Формат: @username или t.me/username

┌─────────────────────────────────┐
│  [◀️ Назад]  [❌ Отмена]        │
└─────────────────────────────────┘
```
*Пользователь отправляет список чатов*

```
✅ Добавлено 3 чата:
• @marketplace_pro
• @wb_sellers_chat
• @ozon_community

┌─────────────────────────────────┐
│  [➕ Добавить ещё]               │
│  [✅ Готово, дальше]             │
│  [◀️ Назад]  [❌ Отмена]        │
└─────────────────────────────────┘
```

**Шаг 4 — Настройки:**
```
➕ Новая программа: "Селлеры WB"

Шаг 4 из 4: Настройки

Текущие настройки:
• Минимальный скор: 5
• Лидов за запуск: макс 20
• Web-обогащение: выкл
• Расписание: ежедневно в 09:00

┌─────────────────────────────────┐
│  [🎚 Изменить настройки]        │
│  [✅ Всё ок, создать]           │
│  [◀️ Назад]  [❌ Отмена]        │
└─────────────────────────────────┘
```

**При нажатии "🎚 Изменить настройки":**
```
⚙️ Настройки программы

┌─────────────────────────────────┐
│  Минимальный скор: [3][4][5][6][7][8] │
├─────────────────────────────────┤
│  Лидов за запуск: [10][20][50]  │
├─────────────────────────────────┤
│  Web-обогащение: [Вкл][Выкл]    │
├─────────────────────────────────┤
│  Время запуска:                 │
│  [06:00][09:00][12:00][18:00][21:00] │
├─────────────────────────────────┤
│  [✅ Сохранить]                 │
└─────────────────────────────────┘
```

**После создания:**
```
✅ Программа создана!

📁 Селлеры WB
• 3 чата
• Скор ≥5
• Запуск: ежедневно в 09:00

Первый автозапуск: завтра в 09:00

┌─────────────────────────────────┐
│  [▶️ Запустить сейчас]          │
│  [📋 К программам]              │
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

---

### Редактирование программы

При нажатии "✏️ Изменить" в карточке программы:

```
✏️ Редактирование: Селлеры WB

Что изменить?

┌─────────────────────────────────┐
│  [📝 Название]                  │
│  [🎯 Описание ниши]             │
│  [💬 Чаты]                      │
│  [⚙️ Настройки]                 │
│  [⏰ Расписание]                │
├─────────────────────────────────┤
│  [◀️ Назад к программе]         │
└─────────────────────────────────┘
```

**При редактировании чатов:**
```
💬 Чаты программы: Селлеры WB

Текущие чаты:
• @marketplace_pro [❌]
• @wb_sellers_chat [❌]
• @ozon_community [❌]

Отправь новые чаты для добавления
или нажми [❌] чтобы удалить существующий.

┌─────────────────────────────────┐
│  [✅ Готово]                    │
│  [◀️ Назад]                     │
└─────────────────────────────────┘
```

---

### Удаление программы

При нажатии "🗑 Удалить":

```
🗑 Удаление программы

Точно удалить "Селлеры WB"?

Будут удалены:
• Настройки программы
• История найденных лидов (47 шт)

Это действие нельзя отменить.

┌─────────────────────────────────┐
│  [🗑 Да, удалить]               │
│  [◀️ Нет, вернуться]            │
└─────────────────────────────────┘
```

---

### Запуск программы

При нажатии "▶️ Запустить сейчас":

```
⏳ Запускаю "Селлеры WB"...

Парсинг чатов: ░░░░░░░░░░ 0/3
```

*Обновляется по мере выполнения:*

```
⏳ Запускаю "Селлеры WB"...

Парсинг чатов: █████░░░░░ 2/3
Найдено участников: 234
```

*После завершения:*

```
✅ Готово!

📊 Результаты запуска "Селлеры WB":

• Участников найдено: 312
• С каналами: 45
• Квалифицировано: 12
• Новых лидов: 8

Отправляю карточки лидов...

┌─────────────────────────────────┐
│  [📋 К программам]              │
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

---

### Карточка лида

После запуска программы бот присылает карточки лидов:

```
🎯 Лид #1 из 8
Программа: Селлеры WB
━━━━━━━━━━━━━━━━━━━━━━━━━━━

👤 @VerevkinAV77
⭐ Оценка: 6/10

💼 Бизнес:
Автоматизация для селлеров WB/Ozon
Малый бизнес или самозанятый

😤 Боли:
• Потеря заявок между мессенджерами и Excel
• Неудобство текущих процессов

💡 Что предложить:
Бот для централизованного сбора заявок
с интеграцией в CRM

━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────┐
│  [📝 Показать сообщение]        │
├─────────────────────────────────┤
│  [✅ Написал]  [❌ Пропустить]  │
├─────────────────────────────────┤
│  [⏭ Следующий лид]              │
└─────────────────────────────────┘
```

**При нажатии "📝 Показать сообщение":**

```
📝 Сообщение для @VerevkinAV77:

━━━━━━━━━━━━━━━━━━━━━━━━━━━

Андрей, привет! Видел ваше сообщение о том, 
что заявки теряются между мессенджерами и Excel. 
У нас есть готовое решение — Telegram-бот, 
который централизует заявки и интегрируется 
с таблицами или CRM. Могу показать?

━━━━━━━━━━━━━━━━━━━━━━━━━━━

👆 Скопируй и отправь @VerevkinAV77

┌─────────────────────────────────┐
│  [◀️ Назад к карточке]          │
└─────────────────────────────────┘
```

---

### Статистика

При нажатии "📊 Статистика" в главном меню:

```
📊 Статистика

Всего программ: 2
Всего найдено лидов: 127

По программам:
━━━━━━━━━━━━━━━━━━━━━━━━━━━

📁 Селлеры WB
• Лидов найдено: 89
• Отмечено "написал": 23
• Последний запуск: сегодня

📁 Инфобизнес
• Лидов найдено: 38
• Отмечено "написал": 12
• Последний запуск: вчера

┌─────────────────────────────────┐
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

---

### Настройки бота

При нажатии "⚙️ Настройки" в главном меню:

```
⚙️ Настройки

Часовой пояс: Москва (UTC+3)
Уведомления о запусках: вкл

┌─────────────────────────────────┐
│  [🌍 Часовой пояс]              │
│  [🔔 Уведомления]               │
├─────────────────────────────────┤
│  [🏠 Главное меню]              │
└─────────────────────────────────┘
```

---

## Автоматические уведомления

### Ежедневный отчёт после автозапуска

Когда программа запускается по расписанию, бот присылает:

```
🔔 Автозапуск завершён

📁 Селлеры WB
⏰ Запуск в 09:00

📊 Результаты:
• Новых лидов: 5

┌─────────────────────────────────┐
│  [👀 Посмотреть лидов]          │
│  [📁 К программе]               │
└─────────────────────────────────┘
```

При нажатии "👀 Посмотреть лидов" — начинает присылать карточки.

### Уведомление об ошибке

```
⚠️ Ошибка при запуске

📁 Селлеры WB
⏰ Запуск в 09:00

Не удалось распарсить чат @some_chat:
"Chat not found or private"

Остальные чаты обработаны успешно.
Новых лидов: 3

┌─────────────────────────────────┐
│  [👀 Посмотреть лидов]          │
│  [✏️ Исправить чаты]            │
└─────────────────────────────────┘
```

---

## Дедупликация лидов

### Правила
- Если лид уже отправлялся из любой программы — не отправлять повторно
- Записи хранятся 90 дней, потом лид может появиться снова
- В карточке программы видно только новых лидов

### Индикация в интерфейсе

В результатах запуска показывается:
- "Квалифицировано: 12" — всего подошли под критерии
- "Новых лидов: 8" — те, кого ещё не отправляли

---

## Логика работы Scheduler

### Автозапуск программ
- Каждая программа запускается в своё заданное время
- Между программами одного пользователя — пауза 5 минут
- При ошибке — retry через 1 час

### Что происходит при запуске
1. Получить список чатов программы
2. Парсить участников из каждого чата
3. Найти тех, у кого есть каналы
4. Обогатить данные (если включено)
5. Квалифицировать через LLM
6. Отфильтровать уже отправленных
7. Сохранить в БД
8. Отправить уведомление пользователю

---

## Технические компоненты

### Telegram Bot
- Фреймворк: aiogram 3.x
- FSM для пошаговых диалогов (создание/редактирование программ)
- Callback handlers для всех inline-кнопок

### Scheduler
- APScheduler для запуска по расписанию
- Async jobs
- Логирование каждого запуска

### LeadSense Core
- Существующие модули v2 (members_parser, enrichment, qualifier)
- Интеграция как библиотека

### Database
- SQLite для начала (можно PostgreSQL позже)
- Таблицы: users, programs, program_chats, leads, sent_leads, run_logs

### Хостинг
- Docker-контейнер
- Постоянно запущен (бот + scheduler)
- Volumes для БД и Telegram-сессий

---

## Безопасность

### Доступ
- Бот работает только для одного пользователя (твой telegram_id)
- Остальные получают "⛔ Доступ запрещён"

### Данные
- Все данные хранятся локально
- Telegram-сессия зашифрована
- Бэкапы БД рекомендуются

---

## Расширения на будущее

### Фаза 2: Аналитика конверсии
- Отслеживание: написал → ответил → стал клиентом
- Какие чаты дают лучших лидов
- Какие сообщения работают лучше

### Фаза 3: Улучшенный аутрич
- Шаблоны сообщений с переменными
- A/B тестирование
- Отложенная отправка

### Фаза 4: Множественные источники
- TGStat API
- Парсинг по ключевым словам
- Мониторинг новых чатов

---

## Чеклист реализации

### Этап 1: Основа бота
- [ ] Настройка aiogram 3.x
- [ ] Главное меню с inline-кнопками
- [ ] Навигация между экранами

### Этап 2: Программы
- [ ] FSM для создания программы
- [ ] Список программ
- [ ] Карточка программы
- [ ] Редактирование и удаление

### Этап 3: База данных
- [ ] Модели и миграции
- [ ] CRUD операции
- [ ] Дедупликация лидов

### Этап 4: Интеграция Core
- [ ] Подключение модулей v2
- [ ] Ручной запуск программы
- [ ] Отображение прогресса

### Этап 5: Карточки лидов
- [ ] Форматирование карточек
- [ ] Кнопки действий
- [ ] Пролистывание лидов

### Этап 6: Scheduler
- [ ] APScheduler setup
- [ ] Автозапуск программ
- [ ] Уведомления о результатах

### Этап 7: Production
- [ ] Docker setup
- [ ] Логирование
- [ ] Тестирование end-to-end