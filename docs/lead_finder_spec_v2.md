# LeadSense v2 — Дополнение к ТЗ

## Изменение концепции

### Было (v1)
[Описание ниши] → [Web Search ищет каналы] → [Парсинг] → [Квалификация]Проблема: Web search плохо находит Telegram-каналы, особенно личные каналы владельцев бизнеса.

### Стало (v2)
[Список seed-чатов от пользователя] → [Парсинг участников] → [Web Search обогащает данные] → [Квалификация]Преимущество: Один чат = сотни потенциальных лидов. Качество выше, объём больше.

---

## Новая архитектура

### Общая схема пайплайна v2

┌─────────────────────────────────────────────────────────────┐
│ ВХОД: Список seed-источников от пользователя                │
│                                                             │
│ Форматы:                                                    │
│ • @chat_username — чат, парсим участников                   │
│ • @channel_username — канал, парсим подписчиков/админов     │
│ • t.me/+invite_hash — приватный чат по инвайт-ссылке       │
│ • channels.txt — файл со списком                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 1: Парсинг участников                                   │
│                                                             │
│ Для каждого seed-источника:                                 │
│ • Если чат → получить список участников                     │
│ • Если канал → получить админов + комментаторов            │
│ • Извлечь username каждого участника                        │
│ • Проверить: есть ли у участника свой канал                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 2: Сбор данных о кандидатах                            │
│                                                             │
│ Для каждого участника с каналом:                           │
│ • Парсинг его канала (посты, описание, ссылки)             │
│ • Парсинг его профиля (bio, username)                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 3: Обогащение через Web Search                         │
│                                                             │
│ Для перспективных кандидатов:                              │
│ • Поиск упоминаний в интернете                             │
│ • Поиск сайта, соцсетей                                    │
│ • Поиск интервью, статей, кейсов                           │
│ • Дополнительный контекст о бизнесе                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 4: Квалификация                                         │
│                                                             │
│ LLM анализирует всю собранную информацию:                  │
│ • Данные из Telegram (канал + профиль)                     │
│ • Данные из Web Search (сайт, упоминания)                  │
│ • Выдаёт оценку, боли, идею оффера                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ВЫХОД: Карточки квалифицированных лидов                    │
└─────────────────────────────────────────────────────────────┘---

## Модули системы v2

### 1. Input Module (Обработка входных данных)

Ответственность: Приём и валидация списка seed-источников.

Входные данные:
- Аргументы командной строки: @chat1 @chat2 @channel1
- Или файл: --file sources.txt

Валидация:
- Проверка формата (username, t.me ссылка, инвайт)
- Проверка доступности (можно ли вступить/парсить)
- Определение типа (чат, канал, приватный чат)

Выходные данные:
- Список валидных источников с типами

Формат файла sources.txt:
# Комментарии начинаются с #
# Чаты селлеров WB
@wb_sellers_chat
@wildberries_sellers
t.me/+AbCdEfGhIjK

# Каналы по маркетплейсам  
@marketplace_news### 2. Members Parser Module (Парсинг участников)

Ответственность: Извлечение участников из чатов и каналов.

Входные данные:
- Список seed-источников с типами

Выходные данные:
- Список уникальных пользователей с метаданными

Логика для разных типов источников:

#### Публичный/приватный чат (группа)
1. Подключиться к чату через Telethon
2. Вызвать GetParticipantsRequest
3. Для каждого участника:
   - Сохранить user_id, username, first_name, last_name
   - Проверить поле "about" (bio)
   - Извлечь ссылку на личный канал если есть
4. Опционально: парсить историю сообщений
   - Найти активных участников (кто пишет)
   - Извлечь контекст из их сообщений#### Публичный канал
1. Получить информацию о канале
2. Получить список админов (GetParticipantsRequest с filter=ChannelParticipantsAdmins)
3. Если есть комментарии — парсить комментаторов
4. Если есть связанный чат — парсить его участников#### Приватный канал/чат по инвайту
1. Вступить по инвайт-ссылке (если ещё не участник)
2. Далее как для публичногоФильтрация участников:
- Исключить ботов (is_bot = true)
- Исключить удалённые аккаунты
- Исключить аккаунты без username (нельзя связаться)
- Опционально: исключить неактивных (не писали N дней)

Выходная структура:
{
  "user_id": 123456789,
  "username": "ivan_seller",
  "first_name": "Иван",
  "last_name": "Петров",
  "bio": "Селлер WB | 5 млн оборот | Мой канал @ivan_wb",
  "has_channel": true,
  "channel_username": "ivan_wb",
  "source_chat": "@wb_sellers_chat",
  "messages_in_chat": 47,
  "last_seen": "2024-01-10"
}### 3. Candidate Enrichment Module (Обогащение данных)

Ответственность: Сбор дополнительной информации о кандидате.

Входные данные:
- Данные о пользователе из Members Parser

Источники обогащения:

#### 3.1 Telegram-канал кандидата
Если у пользователя есть канал:
- Парсинг последних 30-50 постов
- Описание канала
- Количество подписчиков
- Частота постинга
- Ссылки из био и постов#### 3.2 Web Search (новая роль)
Поисковые запросы для обогащения:
- "{username} telegram селлер"
- "{first_name} {last_name} wildberries"
- "{channel_name} отзывы"
- site:instagram.com "{username}"
- site:youtube.com "{channel_name}"

Что ищем:
- Сайт бизнеса
- Профили в соцсетях
- Упоминания в статьях/интервью
- Отзывы, кейсы
- Дополнительный контекст о масштабе бизнеса#### 3.3 Анализ сообщений в чате (опционально)
Если парсим историю чата:
- Найти сообщения этого пользователя
- Извлечь контекст: о чём пишет, какие проблемы упоминает
- Это даёт прямые боли из первых устВыходная структура:
{
  "user_data": { /* из Members Parser */ },
  
  "channel_data": {
    "username": "@ivan_wb",
    "title": "Иван | Селлер WB",
    "description": "Делюсь опытом продаж на WB...",
    "subscribers": 2340,
    "posts_count": 156,
    "last_post_date": "2024-01-14",
    "sample_posts": ["текст поста 1", "текст поста 2"],
    "links_found": ["https://ivan-store.ru", "instagram.com/ivan_store"]
  },
  
  "web_search_data": {
    "website": "https://ivan-store.ru",
    "instagram": "https://instagram.com/ivan_store",
    "mentions": [
      {
        "source": "vc.ru",
        "title": "Как я вышел на 5 млн оборота на WB",
        "snippet": "Иван Петров рассказывает о своём опыте..."
      }
    ],
    "additional_context": "Упоминается как эксперт в нише детской одежды"
  },
  
  "chat_messages": [
    {
      "date": "2024-01-10",
      "text": "Кто-нибудь автоматизировал ответы на отзывы? Задолбался вручную..."
    }
  ]
}### 4. Qualifier Module v2 (Обновлённая квалификация)

Изменения относительно v1:
- Получает больше данных (Telegram + Web + сообщения в чате)
- Может точнее определить масштаб бизнеса
- Видит реальные боли из сообщений в чате

Обновлённый промпт:
Контекст: Анализируем потенциального клиента для агентства,
которое разрабатывает Telegram-ботов и Mini Apps.

Доступные данные:
1. Профиль пользователя в Telegram
2. Его личный канал (если есть)
3. Результаты веб-поиска (сайт, соцсети, упоминания)
4. Его сообщения в тематическом чате (если есть)

Задача:

1. ИДЕНТИФИКАЦИЯ
   - Это владелец бизнеса или наёмный сотрудник/блогер?
   - Какой бизнес (ниша, продукт)?
   - Какой масштаб (оборот, команда)?

2. КВАЛИФИКАЦИЯ (1-10)
   - 9-10: Явный владелец активного бизнеса с видимыми болями
   - 7-8: Владелец бизнеса, боли предполагаемые
   - 5-6: Вероятно владелец, мало информации
   - 1-4: Не подходит (блогер, наёмный, неактивен)

3. ВЫЯВЛЕННЫЕ БОЛИ
   - Прямые (из сообщений в чате, постов)
   - Косвенные (типичные для такого бизнеса)
   - Цитаты если есть

4. ИДЕЯ РЕШЕНИЯ
   - Конкретный бот/Mini App
   - Какую боль закрывает
   - Почему именно этому клиенту это нужно

5. ПЕРСОНАЛИЗАЦИЯ АУТРИЧА
   - На что ссылаться (пост, сообщение, статья)
   - Какой hook использовать
   - Готовое первое сообщение---

## CLI интерфейс v2

### Основные команды

# Парсинг участников из чатов (основной режим)
python main.py parse @wb_sellers @ozon_chat @marketplace_talk

# Парсинг из файла со списком
python main.py parse --file sources.txt

# Парсинг с обогащением через web search
python main.py parse @wb_sellers --enrich

# Парсинг с извлечением сообщений из чата
python main.py parse @wb_sellers --with-messages --messages-limit 1000

# Только участники с каналами
python main.py parse @wb_sellers --only-with-channels

# Legacy: поиск через web search (оставляем для совместимости)
python main.py search "селлеры wildberries"### Флаги

--file FILE           Файл со списком источников
--enrich              Обогащать данные через web search
--with-messages       Парсить сообщения участников в чате
--messages-limit N    Лимит сообщений для парсинга (default: 500)
--only-with-channels  Только участники с личными каналами
--min-score N         Минимальный скор квалификации (default: 5)
--max-leads N         Максимум лидов в отчёте (default: 50)
--output-dir PATH     Директория для результатов
--skip-enrichment     Пропустить web search (быстрее, дешевле)
--export-all          Экспортировать всех участников (до квалификации)### Примеры использования

# Быстрый запуск: только Telegram данные, без web search
python main.py parse @wb_sellers --skip-enrichment

# Полный запуск: с обогащением и сообщениями
python main.py parse @wb_sellers --enrich --with-messages

# Максимальный охват: несколько чатов
python main.py parse @chat1 @chat2 @chat3 --enrich --max-leads 100---

## Структура проекта v2

leadsense/
├── main.py                    # CLI интерфейс
├── config.py                  # Конфигурация
│
├── modules/
│   ├── __init__.py
│   ├── input_handler.py       # [NEW] Обработка входных данных
│   ├── members_parser.py      # [NEW] Парсинг участников чатов
│   ├── enrichment.py          # [NEW] Обогащение данных
│   │   ├── telegram.py        # Парсинг каналов (из v1)
│   │   └── web_search.py      # Web search (переработан)
│   ├── qualifier.py           # Квалификация (обновлён)
│   └── output.py              # Вывод результатов
│
├── prompts/
│   └── qualification_v2.txt   # Обновлённый промпт
│
├── sources/                   # [NEW] Файлы с источниками
│   ├── wb_sellers.txt
│   └── logistics.txt
│
├── output/
├── logs/
├── requirements.txt
└── README.md---

## Оценка затрат v2

### Telegram API (бесплатно)
- Парсинг участников: ~30 запросов/сек лимит
- Парсинг каналов: аналогично
- Задержки между запросами: 1-2 сек рекомендуется

### LLM (на одного лида)

| Режим | Input tokens | Output tokens | Цена (GPT-4o-mini) |
|-------|--------------|---------------|-------------------|
| Без обогащения | ~1500 | ~500 | ~$0.001 |
| С web search | ~3000 | ~500 | ~$0.002 |
| С сообщениями | ~4000 | ~600 | ~$0.003 |

### Web Search
- Google Custom Search: 100 запросов/день бесплатно, далее $5/1000
- На одного лида: 2-3 запроса
- 50 лидов/день = 150 запросов = бесплатный лимит

### Примерный бюджет

| Сценарий | Лидов/день | LLM | Web Search | Итого |
|----------|------------|-----|------------|-------|
| Минимальный | 20 | $0.02 | Бесплатно | ~$0.02/день |
| Стандартный | 50 | $0.10 | Бесплатно | ~$0.10/день |
| С обогащением | 50 | $0.15 | Бесплатно | ~$0.15/день |

---

## Ограничения и риски

### Telegram API
- Flood wait: При слишком частых запросах — бан на N секунд/минут
- Приватные чаты: Нужно быть участником
- Скрытые участники: Некоторые чаты скрывают список участников
- Митигация: Задержки между запросами, обработка FloodWaitError

### Этические соображения
- Парсинг публичных данных — легально
- Холодный аутрич — легально, но не спамить
- Рекомендация: персонализированные сообщения, не массовая рассылка

### Качество данных
- Не все участники чата — целевая аудитория
- Не у всех есть каналы
- Квалификация отсеивает нерелевантных

---

## Рекомендуемые seed-источники для старта

### Селлеры WB/Ozon
# Искать чаты по запросам:
# "чат селлеров wb telegram"
# "wildberries sellers chat"
# "сообщество продавцов ozon"

@wb_sellers          # пример
@ozon_sellers_chat   # пример
@marketplace_russia  # пример### Логистика/Перевозки
# "чат логистов telegram"
# "перевозчики telegram группа"

@logistics_chat      # пример
@truckers_russia     # пример### Как найти чаты
1. Поиск в Telegram по ключевым словам
2. Google: "telegram чат селлеров wb"
3. TGStat: поиск чатов по нише (бесплатно смотреть)
4. Спросить в существующих чатах/каналах

---

## Миграция с v1 на v2

### Что сохраняется
- Модуль квалификации (с обновлённым промптом)
- Модуль вывода (без изменений)
- Конфигурация (расширяется)
- Telethon клиент (расширяется функционал)

### Что добавляется
- Input handler для обработки списка источников
- Members parser для извлечения участников
- Enrichment модуль (рефакторинг существующего)

### Что убирается/deprecated
- Автопоиск каналов через web search (остаётся как legacy)
- Генерация поисковых запросов для discovery

---

## Чеклист v2

- [ ] Рефакторинг: разделить парсинг каналов и парсинг участников
- [ ] Новый модуль: input_handler.py
- [ ] Новый модуль: members_parser.py
- [ ] Обновить: enrichment с web search для обогащения
- [ ] Обновить: промпт квалификации
- [ ] Обновить: CLI с новыми командами
- [ ] Тест: парсинг участников из тестового чата
- [ ] Тест: обогащение через web search
- [ ] Тест: полный пайплайн

---

## Пример полного запуска

# 1. Создать файл с источниками
echo "@wb_sellers_chat" > sources/wb.txt
echo "@another_wb_chat" >> sources/wb.txt

# 2. Запустить парсинг с обогащением
python main.py parse --file sources/wb.txt --enrich --min-score 6

# 3. Результат
# Found 347 members in 2 chats
# 89 members have personal channels
# Enriching 89 candidates...
# Qualifying 89 candidates...
# 23 leads qualified (score >= 6)
# Saved to: output/leads_20240115_143000.json
# Saved to: output/leads_20240115_143000.md