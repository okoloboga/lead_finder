name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script_stop: true
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_BRANCH="${{ secrets.DEPLOY_BRANCH || 'main' }}"

            if [ -z "${DEPLOY_PATH}" ]; then
              echo "DEPLOY_PATH secret is empty"
              exit 1
            fi

            if [ ! -d "${DEPLOY_PATH}" ]; then
              echo "Directory not found: ${DEPLOY_PATH}"
              exit 1
            fi

            cd "${DEPLOY_PATH}"

            if [ ! -d ".git" ]; then
              echo "Not a git repository: ${DEPLOY_PATH}"
              exit 1
            fi

            if ! git diff --quiet || ! git diff --cached --quiet; then
              echo "Repository has local changes; refusing deploy."
              exit 1
            fi

            git fetch origin "${DEPLOY_BRANCH}"
            git checkout "${DEPLOY_BRANCH}"
            git pull --ff-only origin "${DEPLOY_BRANCH}"
            docker compose up -d --build --remove-orphans
